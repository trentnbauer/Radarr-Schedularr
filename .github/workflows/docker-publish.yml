name: Build and Push to GHCR

on:
  push:
    branches: [ "main" ]
    tags: [ 'v*.*.*' ]
    paths-ignore:
      - '**.md'
      - 'docker-compose*.yml'
      - '.gitignore'
      - 'LICENSE'
      - '.github/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- ROBUST PYTHON STEP ---
      # We use Python to handle the text processing safely.
      # No more bash quoting or YAML syntax errors.
      - name: Get Commit Message
        id: get_msg
        shell: python
        run: |
          import os
          import subprocess

          try:
              # Get raw commit message
              raw_msg = subprocess.check_output(["git", "log", "-1", "--format=%B"], text=True).strip()
              
              # Flatten newlines to spaces to prevent YAML breakage
              clean_msg = raw_msg.replace("\n", "
